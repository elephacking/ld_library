#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <Shlwapi.h> // include the Shlwapi library for PathRemoveFileSpec()

#pragma comment(lib, "Shlwapi.lib") // Link with the Shlwapi library

#define MAX_PATH_LENGTH 256

//via kernel32 LoadLibrary
//unsigned char shellcode[] = "\x57\x48\x89\xe7\x48\x83\xe4\xf0\x48\x83\xec\x20\xe8\x9f\x01\x00\x00\x48\x89\xfc\x5f\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x65\x48\x8b\x04\x25\x60\x00\x00\x00\x48\x8b\x40\x18\x4c\x8b\x40\x20\x4d\x85\xc0\x74\x3e\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x49\x8b\x48\x50\x31\xd2\x0f\xb7\x01\x0f\x1f\x80\x00\x00\x00\x00\xc1\xca\x0d\x0f\xbe\xc0\x48\x83\xc1\x02\x01\xc2\x0f\xb7\x01\x66\x85\xc0\x75\xec\x81\xfa\x17\xca\x2b\x6e\x74\x0c\x4d\x8b\x00\x4d\x85\xc0\x75\xcc\x4c\x89\xc0\xc3\x4d\x8b\x40\x20\x4c\x89\xc0\xc3\x65\x48\x8b\x04\x25\x60\x00\x00\x00\x48\x8b\x40\x18\x4c\x8b\x40\x20\x4d\x85\xc0\x74\x3e\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x49\x8b\x48\x50\x31\xd2\x0f\xb7\x01\x0f\x1f\x80\x00\x00\x00\x00\xc1\xca\x0d\x0f\xbe\xc0\x48\x83\xc1\x02\x01\xc2\x0f\xb7\x01\x66\x85\xc0\x75\xec\x81\xfa\x22\xe8\xf6\xce\x74\x0c\x4d\x8b\x00\x4d\x85\xc0\x75\xcc\x4c\x89\xc0\xc3\x4d\x8b\x40\x20\x4c\x89\xc0\xc3\x48\x85\xc9\x0f\x84\xc4\x00\x00\x00\x57\x49\x89\xd2\x48\x89\xc8\x56\x53\x48\x63\x51\x3c\x8b\x94\x11\x88\x00\x00\x00\x48\x01\xca\x8b\x72\x1c\x48\x01\xce\x41\xf7\xc2\x00\x00\xff\xff\x74\x71\x44\x8b\x42\x18\x41\x8d\x48\xff\x45\x85\xc0\x74\x54\x44\x8b\x4a\x20\x44\x8b\x5a\x24\x49\x01\xc1\x49\x8d\x5c\x89\x04\x49\x01\xc3\x90\x41\x8b\x11\x4c\x89\xd7\x48\x01\xc2\x48\x29\xd7\xeb\x07\x66\x90\x44\x38\xc1\x75\x53\x48\x89\xd1\x48\x83\xc2\x01\x44\x0f\xb6\x44\x3a\xff\x0f\xb6\x09\x84\xc9\x75\xe7\x41\x0f\xb6\xc8\xf7\xd9\x85\xc9\x74\x3c\x49\x83\xc1\x04\x49\x83\xc3\x02\x49\x39\xd9\x75\xc0\x5b\x31\xc0\x5e\x5f\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x8b\x52\x10\x45\x0f\xb7\xd2\x5b\x49\x29\xd2\x42\x8b\x14\x96\x5e\x5f\x48\x01\xd0\xc3\x0f\x1f\x00\x44\x29\xc1\x85\xc9\x75\xc4\x41\x0f\xb7\x13\x5b\x8b\x14\x96\x5e\x5f\x48\x01\xd0\xc3\x31\xc0\xc3\x53\x48\x89\xcb\x48\x83\xec\x30\xe8\x63\xfe\xff\xff\x48\x8d\x54\x24\x23\x48\x89\xc1\x48\xb8\x4c\x6f\x61\x64\x4c\x69\x62\x72\x48\x89\x44\x24\x23\x48\xb8\x69\x62\x72\x61\x72\x79\x57\x00\x48\x89\x44\x24\x28\xe8\xf8\xfe\xff\xff\x48\x83\xc4\x30\x48\x89\xd9\x5b\xff\xe0\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x31\xc0\xeb\x0d\x0f\x1f\x40\x00\x48\x83\xc0\x01\x45\x38\xc8\x75\x1f\x44\x0f\xb6\x04\x01\x44\x0f\xb6\x0c\x02\x45\x84\xc0\x75\xe8\x41\x0f\xb6\xc1\xf7\xd8\xc3\x66\x0f\x1f\x84\x00\x00\x00\x00\x00\x41\x0f\xb6\xc0\x44\x29\xc8\xc3\x90\x90\x90\x90\x90\x90\x90\x90\x31\xc0\x66\x83\x39\x00\x75\x23\xc3\x0f\x1f\x80\x00\x00\x00\x00\x66\x83\x7c\x41\x04\x00\x74\x28\x66\x83\x7c\x41\x06\x00\x74\x28\x48\x83\xc0\x04\x66\x83\x3c\x41\x00\x74\x25\x66\x83\x7c\x41\x02\x00\x75\xdd\x48\x83\xc0\x01\xc3\x0f\x1f\x84\x00\x00\x00\x00\x00\x48\x83\xc0\x02\xc3\x0f\x1f\x00\x48\x83\xc0\x03\xc3\x0f\x1f\x00\xc3\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xff\xff\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00";
//via ntdll LdrLoadDll
unsigned char shellcode[] = "\x57\x48\x89\xe7\x48\x83\xe4\xf0\x48\x83\xec\x20\xe8\x9f\x01\x00\x00\x48\x89\xfc\x5f\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x65\x48\x8b\x04\x25\x60\x00\x00\x00\x48\x8b\x40\x18\x4c\x8b\x40\x20\x4d\x85\xc0\x74\x3e\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x49\x8b\x48\x50\x31\xd2\x0f\xb7\x01\x0f\x1f\x80\x00\x00\x00\x00\xc1\xca\x0d\x0f\xbe\xc0\x48\x83\xc1\x02\x01\xc2\x0f\xb7\x01\x66\x85\xc0\x75\xec\x81\xfa\x17\xca\x2b\x6e\x74\x0c\x4d\x8b\x00\x4d\x85\xc0\x75\xcc\x4c\x89\xc0\xc3\x4d\x8b\x40\x20\x4c\x89\xc0\xc3\x65\x48\x8b\x04\x25\x60\x00\x00\x00\x48\x8b\x40\x18\x4c\x8b\x40\x20\x4d\x85\xc0\x74\x3e\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x49\x8b\x48\x50\x31\xd2\x0f\xb7\x01\x0f\x1f\x80\x00\x00\x00\x00\xc1\xca\x0d\x0f\xbe\xc0\x48\x83\xc1\x02\x01\xc2\x0f\xb7\x01\x66\x85\xc0\x75\xec\x81\xfa\x22\xe8\xf6\xce\x74\x0c\x4d\x8b\x00\x4d\x85\xc0\x75\xcc\x4c\x89\xc0\xc3\x4d\x8b\x40\x20\x4c\x89\xc0\xc3\x48\x85\xc9\x0f\x84\xc4\x00\x00\x00\x57\x49\x89\xd2\x48\x89\xc8\x56\x53\x48\x63\x51\x3c\x8b\x94\x11\x88\x00\x00\x00\x48\x01\xca\x8b\x72\x1c\x48\x01\xce\x41\xf7\xc2\x00\x00\xff\xff\x74\x71\x44\x8b\x42\x18\x41\x8d\x48\xff\x45\x85\xc0\x74\x54\x44\x8b\x4a\x20\x44\x8b\x5a\x24\x49\x01\xc1\x49\x8d\x5c\x89\x04\x49\x01\xc3\x90\x41\x8b\x11\x4c\x89\xd7\x48\x01\xc2\x48\x29\xd7\xeb\x07\x66\x90\x44\x38\xc1\x75\x53\x48\x89\xd1\x48\x83\xc2\x01\x44\x0f\xb6\x44\x3a\xff\x0f\xb6\x09\x84\xc9\x75\xe7\x41\x0f\xb6\xc8\xf7\xd9\x85\xc9\x74\x3c\x49\x83\xc1\x04\x49\x83\xc3\x02\x49\x39\xd9\x75\xc0\x5b\x31\xc0\x5e\x5f\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x8b\x52\x10\x45\x0f\xb7\xd2\x5b\x49\x29\xd2\x42\x8b\x14\x96\x5e\x5f\x48\x01\xd0\xc3\x0f\x1f\x00\x44\x29\xc1\x85\xc9\x75\xc4\x41\x0f\xb7\x13\x5b\x8b\x14\x96\x5e\x5f\x48\x01\xd0\xc3\x31\xc0\xc3\x55\x48\x89\xe5\x53\x48\x89\xcb\x48\x83\xe4\xf0\x48\x83\xec\x50\xe8\xbb\xfe\xff\xff\x48\x8d\x54\x24\x35\x48\x89\xc1\x48\xb8\x4c\x64\x72\x4c\x6f\x61\x64\x44\x48\x89\x44\x24\x35\xc7\x44\x24\x3c\x44\x6c\x6c\x00\xe8\xf7\xfe\xff\xff\x4c\x8d\x4c\x24\x28\x48\x89\xd9\x31\xd2\x4c\x8d\x44\x24\x40\x49\x89\xc2\xe8\x70\x00\x00\x00\x01\xc0\x66\x89\x44\x24\x40\xe8\x64\x00\x00\x00\x48\x89\x5c\x24\x48\x31\xc9\x8d\x44\x00\x02\x66\x89\x44\x24\x42\x41\xff\xd2\x48\x8b\x5d\xf8\xc9\xc3\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x31\xc0\xeb\x0d\x0f\x1f\x40\x00\x48\x83\xc0\x01\x45\x38\xc8\x75\x1f\x44\x0f\xb6\x04\x01\x44\x0f\xb6\x0c\x02\x45\x84\xc0\x75\xe8\x41\x0f\xb6\xc1\xf7\xd8\xc3\x66\x0f\x1f\x84\x00\x00\x00\x00\x00\x41\x0f\xb6\xc0\x44\x29\xc8\xc3\x90\x90\x90\x90\x90\x90\x90\x90\x31\xc0\x66\x83\x39\x00\x75\x23\xc3\x0f\x1f\x80\x00\x00\x00\x00\x66\x83\x7c\x41\x04\x00\x74\x28\x66\x83\x7c\x41\x06\x00\x74\x28\x48\x83\xc0\x04\x66\x83\x3c\x41\x00\x74\x25\x66\x83\x7c\x41\x02\x00\x75\xdd\x48\x83\xc0\x01\xc3\x0f\x1f\x84\x00\x00\x00\x00\x00\x48\x83\xc0\x02\xc3\x0f\x1f\x00\x48\x83\xc0\x03\xc3\x0f\x1f\x00\xc3\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\xff\xff\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00";


void showHelp() {
    printf("Usage: ld_library.exe -e <full_path_to_executable> -d <injected_DLL> [additional_args]\n");
    printf("Example: ld_library.exe -e \"C:\\target.exe\" -d hook.dll");
}

int main(int argc, char *argv[]) {
    char exePath[MAX_PATH_LENGTH] = "";
    char dllName[MAX_PATH_LENGTH] = "";
    char additionalArgs[MAX_PATH_LENGTH * 10] = "";
    char directory[MAX_PATH];
    BOOL e_flags, d_flags = FALSE;
    size_t wlen;

    // Check if the number of arguments is less than 2
    if (argc < 2) {
        showHelp();
        return 1;
    }

    // Parse command-line arguments
    for (int i = 1; i < argc; ++i) {
        if (strcmp(argv[i], "-h") == 0) {
            showHelp();
            return 0;
        } else if (strcmp(argv[i], "-e") == 0) {
            e_flags = TRUE;
            if (i + 1 < argc) {
                strcpy_s(exePath, MAX_PATH, argv[++i]);
                strcat(additionalArgs, "\""); // Add opening quote
                strcat(additionalArgs, exePath);
                strcat(additionalArgs, "\" "); // Add closing quote
            } else {
                printf("Missing argument for -e");
                return 1;
            }
        } else if (strcmp(argv[i], "-d") == 0) {
            d_flags = TRUE;
            if (i + 1 < argc) {
                strcpy_s(dllName, MAX_PATH, argv[++i]);
            } else {
                printf("Missing argument for -d");
                return 1;
            }
        } else if (e_flags && d_flags) {
            // Combine additional arguments into a single long string
            strcat(additionalArgs, "\""); // Add opening quote
            strcat(additionalArgs, argv[i]);
            strcat(additionalArgs, "\" "); // Add closing quote
        }
    }

    if (!e_flags | !d_flags) {
        printf("Missing argument -e or -d");
        return 1;
    }

    //remove the last space
    additionalArgs[strlen(additionalArgs)] = '\0';

    //extract path for current directory
    strcpy_s(directory, MAX_PATH, exePath);
    if (!PathRemoveFileSpecA(directory)) {
        perror("Error extracting directory from executable path");
        return 1;
    }

    //convert dll to wchar_t
    wlen = strlen(dllName);
    if (wlen == (size_t)-1) {
        printf("Error converting argument to wide-character string");
        return 1;
    }
    wchar_t* wcsdllName = (wchar_t*)malloc((wlen + 1) * sizeof(wchar_t));
    if (!wcsdllName) {
        perror("Memory allocation failed");
        return 1;
    }
    mbstowcs(wcsdllName, dllName, wlen + 1);

    // Print the concatenated string
    printf("[+] loading dll: %ls\n", wcsdllName);
    printf("[+] executable with arguments: %s\n", additionalArgs);
    printf("[+] current directory: %s\n", directory);

	STARTUPINFOA sinfo = { 0 };
	sinfo.cb = sizeof(STARTUPINFOA);
	PROCESS_INFORMATION pinfo = { 0 };
    
	if (CreateProcessA(NULL, additionalArgs, NULL, NULL, TRUE, CREATE_SUSPENDED, NULL, directory, &sinfo, &pinfo)) {
		printf("[+] PID: %lu\n", pinfo.dwProcessId);
		LPVOID lpshellcode = VirtualAllocEx(pinfo.hProcess, NULL, sizeof(shellcode), MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);
        LPVOID lpwcsdllName = VirtualAllocEx(pinfo.hProcess, NULL, wcslen(wcsdllName)*2+2, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
		if (lpshellcode && lpwcsdllName) {
			if (WriteProcessMemory(pinfo.hProcess, lpshellcode, shellcode, sizeof(shellcode), 0) && WriteProcessMemory(pinfo.hProcess, lpwcsdllName, wcsdllName, wcslen(wcsdllName)*2+2, 0)) {
				QueueUserAPC((PAPCFUNC)lpshellcode, pinfo.hThread, (ULONG_PTR)lpwcsdllName);
				ResumeThread(pinfo.hThread);
				WaitForSingleObject(pinfo.hThread, INFINITE);
			} else {
                printf("failed to write to the remote process memory");
            }
		}
	}
	return 0;
}

